{% extends 'base.html' %} {% load static %} {% block meta %}
<title>Login</title>
{% endblock meta %} {% block content %}

<div
  class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8"
>
  <div
    class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-5"
    style="background-image: url('{% static 'images/hero.jpeg' %}')"
  ></div>

  <div class="max-w-md w-full space-y-8 relative z-10">
    <div class="animate-fade-in">
      <!-- Header -->
      <div class="text-center">
        <h2 class="text-4xl font-bold text-gray-900 mb-2">Welcome Back</h2>
        <p class="text-gray-600">Sign in to your Manchester Shop account</p>
        <div
          class="w-16 h-1 bg-gradient-to-r from-[#db1d24] to-red-600 mx-auto mt-4 rounded-full"
        ></div>
      </div>

      <!-- Login Form -->
      <div
        class="mt-8 bg-white/80 backdrop-blur-sm rounded-xl shadow-xl p-8 border border-gray-200"
      >
        <form id="login-form" class="space-y-6">
          {% csrf_token %}

          <!-- Username Field -->
          <div class="w-full">
            <label
              for="{{ form.username.id_for_label }}"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Username
            </label>
            <div class="relative w-full">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  ></path>
                </svg>
              </div>
              {{ form.username }}
            </div>
          </div>

          <!-- Password Field -->
          <div>
            <label
              for="{{ form.password.id_for_label }}"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Password
            </label>
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                  ></path>
                </svg>
              </div>
              {{ form.password }}
            </div>
          </div>

          <!-- Submit Button -->
          <div>
            <button
              type="submit"
              id="submit-btn"
              class="w-full bg-gradient-primary hover:bg-gradient-primary-hover text-white font-semibold py-4 px-6 rounded-lg transition-all duration-300 hover:-translate-y-0.5 shadow-lg hover:shadow-xl uppercase tracking-wider text-sm"
            >
              <span id="submit-text">Sign In</span>
              <div
                id="loading-spinner"
                class="inline-block ml-2"
                style="display: none"
              >
                <svg
                  class="animate-spin h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </div>
            </button>
          </div>
        </form>

        <!-- Messages -->
        {% if messages %}
        <div class="mt-6 space-y-2">
          {% for message in messages %}
          <div
            class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm flex items-center"
          >
            <svg
              class="h-4 w-4 mr-2 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Register Link -->
        <div class="mt-8 text-center">
          <p class="text-gray-600">
            Don't have an account yet?
            <a
              href="{% url 'main:register' %}"
              class="font-semibold text-[#db1d24] hover:text-red-700 transition-colors duration-300 ml-1"
            >
              Register Now
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Component -->
{% include 'toast.html' %}

<script>
  // Add custom styling to Django form fields
  document.addEventListener("DOMContentLoaded", function () {
    const formInputs = document.querySelectorAll("#id_username, #id_password");
    formInputs.forEach((input) => {
      input.className = "form-input w-full py-4 rounded-xl pl-10";
      input.placeholder =
        input.name === "username"
          ? "Enter your username"
          : "Enter your password";
    });

    // AJAX Login Form Handler
    const loginForm = document.getElementById("login-form");
    const submitBtn = document.getElementById("submit-btn");
    const submitText = document.getElementById("submit-text");
    const loadingSpinner = document.getElementById("loading-spinner");

    loginForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      // Clear previous error messages
      clearFieldErrors();

      // Show loading state
      setLoadingState(true);

      try {
        // Get form data
        const formData = new FormData(loginForm);
        const data = {};

        for (let [key, value] of formData.entries()) {
          if (key !== "csrfmiddlewaretoken") {
            data[key] = value;
          }
        }

        // Send AJAX request
        const response = await fetch("/login-ajax/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          // Show success toast
          showToast("Welcome!", result.message, "success");

          // Set cookie for last_login
          document.cookie = `last_login=${new Date().toISOString()}; path=/`;

          // Redirect after short delay
          setTimeout(() => {
            window.location.href = result.redirect_url || "/";
          }, 1500);
        } else {
          // Show field errors
          if (result.errors) {
            showFieldErrors(result.errors);
          } else {
            showToast(
              "Login Failed!",
              result.message || "Invalid credentials",
              "error"
            );
          }
        }
      } catch (error) {
        console.error("Error:", error);
        showToast(
          "Network Error!",
          "Please check your connection and try again.",
          "error"
        );
      } finally {
        setLoadingState(false);
      }
    });

    function setLoadingState(loading) {
      if (loading) {
        submitBtn.disabled = true;
        submitText.textContent = "Signing In...";
        loadingSpinner.style.display = "inline-block";
      } else {
        submitBtn.disabled = false;
        submitText.textContent = "Sign In";
        loadingSpinner.style.display = "none";
      }
    }

    function clearFieldErrors() {
      // Remove existing error displays
      document.querySelectorAll(".field-error").forEach((el) => el.remove());

      // Remove error styling from inputs
      formInputs.forEach((input) => {
        input.classList.remove("border-red-500");
        input.classList.add("border-gray-300");
      });
    }

    function showFieldErrors(errors) {
      for (const [fieldName, fieldErrors] of Object.entries(errors)) {
        const field = loginForm.querySelector(`[name="${fieldName}"]`);
        if (field) {
          // Add error styling to field
          field.classList.remove("border-gray-300");
          field.classList.add("border-red-500");

          // Create error message element
          const errorDiv = document.createElement("div");
          errorDiv.className = "field-error text-red-600 text-sm mt-1";
          errorDiv.textContent = fieldErrors.join(", ");

          // Insert error message after the field's parent
          field.parentElement.appendChild(errorDiv);
        }
      }
    }
  });
</script>

{% endblock content %}
